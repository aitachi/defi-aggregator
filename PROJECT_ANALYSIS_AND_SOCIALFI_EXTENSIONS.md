# DeFi Aggregator - å®Œæ•´é¡¹ç›®åˆ†æä¸SocialFiæ‰©å±•æ–¹æ¡ˆ

## ğŸ“Š é¡¹ç›®çŠ¶æ€æ€»ç»“

### âœ… ä»£ç è´¨é‡çŠ¶æ€
- **ç¼–è¯‘çŠ¶æ€**: âœ… é€šè¿‡ (0 è­¦å‘Š, 0 é”™è¯¯)
- **Lintæ£€æŸ¥**: âœ… é€šè¿‡ (0 é”™è¯¯, 0 è­¦å‘Š)
- **ç±»å‹å®‰å…¨**: âœ… å®Œå…¨ç±»å‹åŒ–
- **æµ‹è¯•è¦†ç›–**: ğŸŸ¡ éƒ¨åˆ†é€šè¿‡ (æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•é€šè¿‡, é›†æˆæµ‹è¯•éƒ¨åˆ†åŠŸèƒ½å¾…å®ç°)
- **å®‰å…¨å®¡è®¡**: ğŸŸ¡ ä»£ç ç»“æ„å®‰å…¨,å»ºè®®ç¬¬ä¸‰æ–¹å®¡è®¡

---

## ğŸ“‹ ç¬¬ä¸€éƒ¨åˆ†: ç°æœ‰åç«¯åŠŸèƒ½è¯¦ç»†æ¸…å•

### 1ï¸âƒ£ æ ¸å¿ƒèµ„äº§ç®¡ç†ç³»ç»Ÿ

#### **1.1 Vault (é‡‘åº“) ç³»ç»Ÿ**
ğŸ“ `contracts/core/Vault.sol` | çŠ¶æ€: âœ… å·²éƒ¨ç½²

**åŠŸèƒ½æè¿°**:
- **å¤šä»£å¸æ”¯æŒ**: æ”¯æŒä»»æ„ERC20ä»£å¸çš„å­˜æ¬¾/ææ¬¾
- **ä»½é¢ä»£å¸åŒ–**: ç”¨æˆ·å­˜æ¬¾åè·å¾—é‡‘åº“ä»½é¢,ç±»ä¼¼LPä»£å¸
- **ç­–ç•¥é›†æˆ**: è‡ªåŠ¨å°†èµ„é‡‘åˆ†é…åˆ°æœ€ä¼˜æ”¶ç›Šç­–ç•¥
- **æ‰‹ç»­è´¹æœºåˆ¶**:
  - ç»©æ•ˆè´¹: 10% (ä»åˆ©æ¶¦ä¸­æ‰£é™¤)
  - ç®¡ç†è´¹: 2% å¹´åŒ– (æŒ‰AUMè®¡ç®—)
  - ææ¬¾è´¹: 0.5% (é˜²æ­¢é—ªç”µè´·æ”»å‡»)
- **TVLè¿½è¸ª**: å®æ—¶æ€»é”ä»“ä»·å€¼è®¡ç®—
- **ç™½åå•æ¨¡å¼**: æ”¯æŒç§æœ‰é‡‘åº“(ä»…ç™½åå•ç”¨æˆ·å¯è®¿é—®)
- **æš‚åœåŠŸèƒ½**: ç´§æ€¥æƒ…å†µä¸‹å¯æš‚åœå­˜å–æ¬¾
- **å¯å‡çº§**: UUPSä»£ç†æ¨¡å¼,å¯å¹³æ»‘å‡çº§é€»è¾‘

**å…³é”®å‡½æ•°**:
```solidity
- deposit(address token, uint256 amount) â†’ uint256 shares
- withdraw(address token, uint256 shares) â†’ uint256 amount
- getTotalValue() â†’ uint256 totalValue
- getSharePrice() â†’ uint256 pricePerShare
- setStrategy(address token, address strategy)
- collectFees() â†’ (managementFee, performanceFee)
```

**æŠ€æœ¯äº®ç‚¹**:
- ä½¿ç”¨ä»½é¢ä»·æ ¼æœºåˆ¶å®ç°æ”¶ç›Šè‡ªåŠ¨å¤åˆ©
- æ”¯æŒå¤šç§ä»£å¸åœ¨åŒä¸€é‡‘åº“
- é›†æˆOpenZeppelinçš„Pausableå’ŒOwnable
- äº‹ä»¶é©±åŠ¨æ¶æ„ä¾¿äºé“¾ä¸‹ç›‘æ§

---

#### **1.2 VaultFactory (é‡‘åº“å·¥å‚)**
ğŸ“ `contracts/core/VaultFactory.sol` | çŠ¶æ€: âœ… å·²éƒ¨ç½²

**åŠŸèƒ½æè¿°**:
- **æ‰¹é‡åˆ›å»º**: ä¸€æ¬¡æ€§åˆ›å»ºå¤šä¸ªé‡‘åº“
- **é‡‘åº“æ³¨å†Œè¡¨**: ç»´æŠ¤æ‰€æœ‰å·²åˆ›å»ºé‡‘åº“çš„åˆ—è¡¨
- **åˆ›å»ºæƒé™æ§åˆ¶**: å¯é™åˆ¶åªæœ‰æˆæƒåœ°å€æ‰èƒ½åˆ›å»º
- **åˆ›å»ºè´¹ç”¨**: æ”¯æŒè®¾ç½®åˆ›å»ºé‡‘åº“çš„è´¹ç”¨(é˜²æ­¢åƒåœ¾é‡‘åº“)
- **é‡‘åº“åœç”¨**: ç®¡ç†å‘˜å¯åœç”¨æœ‰é—®é¢˜çš„é‡‘åº“
- **è´¢åº“ç®¡ç†**: åˆ›å»ºè´¹ç”¨å½’é›†åˆ°åè®®è´¢åº“

**å…³é”®å‡½æ•°**:
```solidity
- createVault(address asset) â†’ address vaultAddress
- createVaultBatch(address[] assets) â†’ address[] vaults
- setCreationFee(uint256 fee)
- deactivateVault(address vault)
- getVaultByAsset(address asset) â†’ address vault
```

**åº”ç”¨åœºæ™¯**:
- å…è®¸ç”¨æˆ·ä¸ºä»»æ„ä»£å¸åˆ›å»ºä¸“ç”¨é‡‘åº“
- åè®®å¯é¢„å…ˆåˆ›å»ºä¸»æµä»£å¸é‡‘åº“
- æ”¯æŒç¤¾åŒºæ²»ç†åˆ›å»ºæ–°é‡‘åº“

---

#### **1.3 StrategyManager (ç­–ç•¥ç®¡ç†å™¨)**
ğŸ“ `contracts/core/StrategyManager.sol` | çŠ¶æ€: âœ… å·²éƒ¨ç½²

**åŠŸèƒ½æè¿°**:
- **ç­–ç•¥æ³¨å†Œ**: æ–°ç­–ç•¥æ³¨å†Œéœ€åŒ…å«åç§°ã€æè¿°ã€é£é™©ç­‰çº§
- **é£é™©è¯„åˆ†**: æ¯ä¸ªç­–ç•¥æœ‰0-100çš„é£é™©åˆ†æ•°
- **APYè¿½è¸ª**: è®°å½•å¹¶æ›´æ–°ç­–ç•¥å†å²APY
- **ç­–ç•¥éªŒè¯**: ç®¡ç†å‘˜å®¡æ ¸ç­–ç•¥åæ‰èƒ½æ¿€æ´»
- **ç­–ç•¥åœç”¨**: å¯ç´§æ€¥åœç”¨æœ‰é—®é¢˜çš„ç­–ç•¥
- **æ‰¹é‡æ“ä½œ**: æ”¯æŒæ‰¹é‡æ³¨å†Œ/æ›´æ–°ç­–ç•¥
- **åè®®ç™½åå•**: åªæœ‰ç™½åå•åè®®çš„ç­–ç•¥æ‰èƒ½æ³¨å†Œ

**å…³é”®å‡½æ•°**:
```solidity
- registerStrategy(address strategy, string name, string description, address[] protocols, uint256 riskScore)
- verifyStrategy(address strategy)
- deactivateStrategy(address strategy)
- updateStrategyAPY(address strategy, uint256 apy)
- getActiveStrategies() â†’ address[] strategies
- whitelistProtocol(address protocol)
```

**æ²»ç†æœºåˆ¶**:
- STRATEGIST_ROLE: å¯æ³¨å†Œå’Œæ›´æ–°ç­–ç•¥
- ADMIN_ROLE: å¯éªŒè¯å’Œåœç”¨ç­–ç•¥
- æ”¯æŒåˆ†æƒç®¡ç†

---

### 2ï¸âƒ£ æ”¶ç›Šç­–ç•¥ç³»ç»Ÿ

#### **2.1 BaseStrategy (ç­–ç•¥åŸºç±»)**
ğŸ“ `contracts/strategies/BaseStrategy.sol` | çŠ¶æ€: âœ… å·²ä¿®å¤å‡çº§å®‰å…¨é—®é¢˜

**åŠŸèƒ½æè¿°**:
- **æŠ½è±¡åŸºç±»**: æ‰€æœ‰ç­–ç•¥å¿…é¡»ç»§æ‰¿æ­¤åˆçº¦
- **æ ‡å‡†æ¥å£**: ç»Ÿä¸€çš„deposit/withdraw/harvestæ¥å£
- **ç»©æ•ˆè´¹**: æ¯æ¬¡harvestæ—¶è‡ªåŠ¨æ‰£é™¤10%ç»©æ•ˆè´¹
- **èµ„äº§è¿½è¸ª**: totalDepositedè®°å½•ç­–ç•¥æ€»å­˜æ¬¾
- **æ”¶è·è®°å½•**: lastHarvestè®°å½•ä¸Šæ¬¡æ”¶è·æ—¶é—´
- **æƒé™æ§åˆ¶**: åªæœ‰é‡‘åº“å¯è°ƒç”¨deposit/withdraw
- **ç´§æ€¥ææ¬¾**: æ‰€æœ‰è€…å¯ç´§æ€¥æå–æ‰€æœ‰èµ„é‡‘
- **å¯å‡çº§**: UUPSæ¨¡å¼,ç­–ç•¥å¯å¹³æ»‘å‡çº§

**æ ¸å¿ƒæµç¨‹**:
```
1. Vaultè°ƒç”¨ deposit() â†’ èµ„é‡‘è½¬å…¥ç­–ç•¥
2. ç­–ç•¥è°ƒç”¨ _deposit() â†’ éƒ¨ç½²åˆ°å¤–éƒ¨åè®®
3. å®šæœŸè°ƒç”¨ harvest() â†’ æ”¶é›†æ”¶ç›Š
4. harvestæ—¶è‡ªåŠ¨æ‰£é™¤10%ç»©æ•ˆè´¹ â†’ è½¬ç»™é‡‘åº“
5. Vaultè°ƒç”¨ withdraw() â†’ ä»åè®®èµå›èµ„é‡‘
```

---

#### **2.2 AaveStrategy (Aaveå€Ÿè´·ç­–ç•¥)**
ğŸ“ `contracts/strategies/AaveStrategy.sol` | çŠ¶æ€: âœ… å·²å®ç°

**åŠŸèƒ½æè¿°**:
- **åè®®**: Aave V3 lending pool
- **æ”¶ç›Šæ¥æº**: å­˜æ¬¾åˆ©æ¯(aTokenè‡ªåŠ¨å¢å€¼)
- **APY**: çº¦3% (å®é™…æ ¹æ®å¸‚åœºæµ®åŠ¨)
- **æ”¯æŒèµ„äº§**: USDC, DAI, USDTç­‰ä¸»æµç¨³å®šå¸
- **è‡ªåŠ¨å¤åˆ©**: aTokenä½™é¢è‡ªåŠ¨å¢é•¿

**å®ç°ç»†èŠ‚**:
```solidity
- _deposit(): è°ƒç”¨ aavePool.supply() å­˜å…¥èµ„äº§
- _withdraw(): è°ƒç”¨ aavePool.withdraw() èµå›èµ„äº§
- _harvest(): è®¡ç®—aTokenå¢å€¼,æå–åˆ©æ¶¦
- totalAssets(): è¿”å› aToken.balanceOf(this)
- estimatedAPY(): è¿”å›3% (å¯æ¥å…¥Aaveå®æ—¶APY)
```

**æŠ€æœ¯ç‰¹ç‚¹**:
- é›†æˆAave V3æœ€æ–°æ¥å£
- æ”¯æŒreferralCode(å¯è®¾ç½®æ¨èè¿”ä½£)
- ä½é£é™©ç­–ç•¥(Aaveæ˜¯ç»è¿‡å……åˆ†éªŒè¯çš„åè®®)

---

#### **2.3 CompoundStrategy (Compoundå€Ÿè´·ç­–ç•¥)**
ğŸ“ `contracts/strategies/CompoundStrategy.sol` | çŠ¶æ€: âœ… å·²å®ç°

**åŠŸèƒ½æè¿°**:
- **åè®®**: Compound V3 (Comet)
- **æ”¶ç›Šæ¥æº**: å­˜æ¬¾åˆ©æ¯
- **APY**: æ ¹æ®Compoundä¾›åº”åˆ©ç‡åŠ¨æ€è°ƒæ•´
- **æ”¯æŒèµ„äº§**: USDC, WETHç­‰
- **èµ„äº§è·Ÿè¸ª**: è®°å½•cTokenä½™é¢

**å®ç°ç»†èŠ‚**:
```solidity
- _deposit(): è°ƒç”¨ comet.supply() å­˜å…¥èµ„äº§
- _withdraw(): è°ƒç”¨ comet.withdraw() èµå›èµ„äº§
- _harvest(): é¢†å–COMPå¥–åŠ±,å–å‡ºæ¢å–æœ¬é‡‘ä»£å¸
- estimatedAPY(): ä» comet.getSupplyRate() è¯»å–å®æ—¶APY
```

**ä¼˜åŠ¿**:
- Compound V3ç®€åŒ–äº†æ¥å£,æ›´çœgas
- æ”¯æŒå®æ—¶APYæŸ¥è¯¢
- COMPä»£å¸é¢å¤–æ”¶ç›Š

---

#### **2.4 CurveStrategy (Curve LPç­–ç•¥)**
ğŸ“ `contracts/strategies/CurveStrategy.sol` | çŠ¶æ€: âœ… å·²å®ç°

**åŠŸèƒ½æè¿°**:
- **åè®®**: Curve Finance + Convex
- **æ”¶ç›Šæ¥æº**:
  1. Curve LPäº¤æ˜“æ‰‹ç»­è´¹
  2. CRVä»£å¸å¥–åŠ±
  3. Convexå¹³å°CVXä»£å¸å¥–åŠ±
- **APY**: çº¦5% (CRV+CVXåŒæŒ–)
- **æ”¯æŒæ± å­**: 3pool(USDC/USDT/DAI), stETHç­‰

**å®ç°ç»†èŠ‚**:
```solidity
- _deposit():
  1. æ·»åŠ æµåŠ¨æ€§åˆ°Curve poolè·å¾—LP token
  2. å°†LP tokenè´¨æŠ¼åˆ°Convex
- _withdraw():
  1. ä»Convexèµå›LP token
  2. ä»Curveç§»é™¤æµåŠ¨æ€§æ¢å›åŸå§‹èµ„äº§
- _harvest():
  1. é¢†å–CRVå’ŒCVXå¥–åŠ±
  2. å–å‡ºæ¢å–ç¨³å®šå¸
  3. é‡æ–°æ·»åŠ æµåŠ¨æ€§(å¤åˆ©)
```

**é£é™©æç¤º**:
- æ— å¸¸æŸå¤±é£é™©(ä½¿ç”¨ç¨³å®šå¸æ± å¯æœ€å°åŒ–)
- æ™ºèƒ½åˆçº¦é£é™©(ä¸¤ä¸ªåè®®ä¾èµ–)
- æµåŠ¨æ€§é£é™©(å¤§é¢èµå›å¯èƒ½äº§ç”Ÿæ»‘ç‚¹)

---

### 3ï¸âƒ£ æ æ†äº¤æ˜“ç³»ç»Ÿ

#### **3.1 LeverageEngine (æ æ†å¼•æ“)**
ğŸ“ `contracts/leverage/LeverageEngine.sol` | çŠ¶æ€: âœ… å·²å®ç°

**åŠŸèƒ½æè¿°**:
- **æœ€å¤§æ æ†**: 5å€ (500%)
- **æ”¯æŒèµ„äº§**: ä»»æ„åœ¨Aaveä¸Šå¯ä½œä¸ºæŠµæŠ¼å“çš„èµ„äº§
- **å€Ÿè´·åè®®**: Aave V3
- **DEXé›†æˆ**: Uniswap (ç”¨äºä»£å¸äº¤æ¢)
- **å¥åº·å› å­**: æœ€ä½1.2 (ä½äº1.1è§¦å‘æ¸…ç®—)
- **ä»“ä½ç®¡ç†**: å¼€ä»“ã€åŠ ä»“ã€å‡ä»“ã€å¹³ä»“
- **ä»·æ ¼é¢„è¨€æœº**: Chainlink

**æ ¸å¿ƒåŠŸèƒ½**:

**3.1.1 å¼€ä»“ (openPosition)**
```solidity
æµç¨‹:
1. ç”¨æˆ·å­˜å…¥æŠµæŠ¼å“(å¦‚10 ETH)
2. æŒ‡å®šæ æ†å€æ•°(å¦‚2x)
3. è®¡ç®—éœ€è¦å€Ÿè´·é‡‘é¢(å¦‚20 ETHä»·å€¼çš„USDC)
4. ä»Aaveå€Ÿå‡ºUSDC
5. åœ¨Uniswapå°†USDCæ¢æˆETH
6. å°†æ¢å¾—çš„ETHä½œä¸ºé¢å¤–æŠµæŠ¼å“å­˜å…¥Aave
7. æœ€ç»ˆæŒæœ‰3å€ETHæ•å£

å‚æ•°:
- collateralAsset: æŠµæŠ¼å“ä»£å¸(å¦‚WETH)
- borrowAsset: å€Ÿè´·ä»£å¸(å¦‚USDC)
- collateralAmount: æŠµæŠ¼å“æ•°é‡
- leverageMultiplier: æ æ†å€æ•°(200=2x)
- minHealthFactor: æœ€å°å¥åº·å› å­(é»˜è®¤1.2)
```

**3.1.2 å¹³ä»“ (closePosition)**
```solidity
æµç¨‹:
1. ä»Aaveèµå›éƒ¨åˆ†æŠµæŠ¼å“
2. åœ¨Uniswapå–å‡ºæ¢æˆå€Ÿè´·ä»£å¸
3. å¿è¿˜Aaveå€ºåŠ¡
4. æå–å‰©ä½™æŠµæŠ¼å“ç»™ç”¨æˆ·

ç›ˆäºè®¡ç®—:
- ä»·æ ¼ä¸Šæ¶¨: ç”¨æˆ·è·å¾—æ æ†æ”¾å¤§çš„æ”¶ç›Š
- ä»·æ ¼ä¸‹è·Œ: ç”¨æˆ·æ‰¿å—æ æ†æ”¾å¤§çš„æŸå¤±
```

**3.1.3 å¥åº·å› å­ç®¡ç†**
```solidity
å¥åº·å› å­ = (æŠµæŠ¼å“ä»·å€¼ Ã— æ¸…ç®—é˜ˆå€¼) / å€ºåŠ¡ä»·å€¼

ç¤ºä¾‹:
- æŠµæŠ¼: 10 ETH @ $2000 = $20000
- å€ºåŠ¡: $15000 USDC
- æ¸…ç®—é˜ˆå€¼: 80%
- å¥åº·å› å­ = ($20000 Ã— 0.8) / $15000 = 1.07

å½“å¥åº·å› å­ < 1.0 æ—¶,ä»“ä½è¢«æ¸…ç®—
```

**å…³é”®å‡½æ•°**:
```solidity
- openPosition(address collateralAsset, address borrowAsset, uint256 collateralAmount, uint256 leverageMultiplier, uint256 minHealthFactor) â†’ uint256 positionId
- closePosition(uint256 positionId)
- addCollateral(uint256 positionId, uint256 amount)
- removeCollateral(uint256 positionId, uint256 amount)
- getHealthFactor(uint256 positionId) â†’ uint256 healthFactor
- getPosition(uint256 positionId) â†’ Position
```

---

#### **3.2 LiquidationBot (æ¸…ç®—æœºå™¨äºº)**
ğŸ“ `contracts/leverage/LiquidationBot.sol` | çŠ¶æ€: âœ… å·²å®ç°

**åŠŸèƒ½æè¿°**:
- **è‡ªåŠ¨ç›‘æ§**: æ‰«ææ‰€æœ‰æ æ†ä»“ä½å¥åº·å› å­
- **æ¸…ç®—è§¦å‘**: å¥åº·å› å­ < 1.1 æ—¶è‡ªåŠ¨æ¸…ç®—
- **æ¸…ç®—å¥–åŠ±**: æ¸…ç®—äººè·å¾—5-10%æ¸…ç®—å¥–åŠ±
- **æ‰¹é‡æ¸…ç®—**: æ”¯æŒä¸€æ¬¡æ¸…ç®—å¤šä¸ªä»“ä½
- **æœºå™¨äººç™½åå•**: åªæœ‰æˆæƒæœºå™¨äººå¯æ‰§è¡Œæ¸…ç®—

**æ¸…ç®—æµç¨‹**:
```
1. ç›‘æ§åˆçº¦è°ƒç”¨ checkNeedsLiquidation(user, positionId)
2. å¦‚æœè¿”å›true,è°ƒç”¨ liquidate(user, positionId)
3. æ¸…ç®—åˆçº¦:
   a. è®¡ç®—éœ€å¿è¿˜å€ºåŠ¡
   b. ä»æŠµæŠ¼å“ä¸­æ‰£é™¤
   c. å¿è¿˜Aaveå€ºåŠ¡
   d. ç»™æ¸…ç®—äºº5%å¥–åŠ±
   e. å‰©ä½™èµ„é‡‘è¿”è¿˜ç”¨æˆ·
```

**å…³é”®å‡½æ•°**:
```solidity
- checkNeedsLiquidation(address user, uint256 positionId) â†’ bool
- liquidate(address user, uint256 positionId) â†’ uint256 reward
- findLiquidatablePositions() â†’ address[] users (å¾…å®Œå–„)
- whitelistBot(address bot, bool status)
```

---

#### **3.3 RebalanceBot (å†å¹³è¡¡æœºå™¨äºº)**
ğŸ“ `contracts/automation/RebalanceBot.sol` | çŠ¶æ€: âœ… å·²å®ç°

**åŠŸèƒ½æè¿°**:
- **ç›®æ ‡**: ç»´æŒç”¨æˆ·è®¾å®šçš„ç›®æ ‡æ æ†å€æ•°
- **è§¦å‘æ¡ä»¶**: å®é™…æ æ†åç¦»ç›®æ ‡è¶…è¿‡é˜ˆå€¼(å¦‚Â±5%)
- **å†å¹³è¡¡æ–¹å¼**:
  - æ æ†è¿‡é«˜ â†’ å¿è¿˜éƒ¨åˆ†å€ºåŠ¡
  - æ æ†è¿‡ä½ â†’ å¢åŠ å€Ÿè´·
- **è‡ªåŠ¨æ‰§è¡Œ**: Keeperå®šæœŸè°ƒç”¨

**ç¤ºä¾‹åœºæ™¯**:
```
ç”¨æˆ·è®¾ç½®: 2xæ æ†,å†å¹³è¡¡é˜ˆå€¼5%
åˆå§‹çŠ¶æ€:
- 10 ETH @ $2000 = $20000æŠµæŠ¼
- å€Ÿè´· $20000 USDC
- å®é™…æ æ†: 2x âœ…

ä»·æ ¼æ¶¨åˆ° $2500:
- 10 ETH @ $2500 = $25000æŠµæŠ¼
- å€ºåŠ¡ä»æ˜¯ $20000
- å®é™…æ æ†: 1.8x âŒ (åç¦»>5%)
- æœºå™¨äººæ‰§è¡Œ: å†å€Ÿ $5000,ä¹°å…¥2 ETH
- ç»“æœ: 12 ETH @ $2500 = $30000æŠµæŠ¼,$25000å€ºåŠ¡
- æ–°æ æ†: 2x âœ…
```

---

### 4ï¸âƒ£ å…ƒäº¤æ˜“(Meta-Transaction)ç³»ç»Ÿ

#### **4.1 MetaTxForwarder (å…ƒäº¤æ˜“è½¬å‘å™¨)**
ğŸ“ `contracts/metatx/MetaTxForwarder.sol` | çŠ¶æ€: âœ… å·²éƒ¨ç½²

**åŠŸèƒ½æè¿°**:
- **gaslessäº¤æ˜“**: ç”¨æˆ·ç­¾åäº¤æ˜“,ä¸­ç»§å™¨æ”¯ä»˜gas
- **EIP-712ç­¾å**: æ ‡å‡†åŒ–çš„ç±»å‹åŒ–æ•°æ®ç­¾å
- **é˜²é‡æ”¾æ”»å‡»**: nonceæœºåˆ¶
- **æ‰¹é‡æ‰§è¡Œ**: ä¸€æ¬¡æäº¤å¤šä¸ªäº¤æ˜“
- **ä¸­ç»§å™¨ç®¡ç†**: ç™½åå•ä¸­ç»§å™¨,ä¿¡èª‰è¯„åˆ†

**å·¥ä½œæµç¨‹**:
```
1. ç”¨æˆ·(æ— ETH):
   - æ„é€ äº¤æ˜“æ•°æ®
   - ç”¨ç§é’¥ç­¾å(EIP-712)
   - å‘é€ç­¾ååˆ°ä¸­ç»§æœåŠ¡å™¨

2. ä¸­ç»§å™¨(æœ‰ETH):
   - éªŒè¯ç­¾åæœ‰æ•ˆæ€§
   - æäº¤åˆ°MetaTxForwarderåˆçº¦
   - æ”¯ä»˜gasè´¹

3. MetaTxForwarder:
   - éªŒè¯ç­¾å
   - æ£€æŸ¥nonce(é˜²é‡æ”¾)
   - ä»¥ç”¨æˆ·èº«ä»½è°ƒç”¨ç›®æ ‡åˆçº¦
   - æ›´æ–°nonce

4. ä¸­ç»§å™¨è·å¾—è¡¥å¿:
   - ä»GasStationé¢†å–è¡¥è´´
   - æˆ–ä»ç”¨æˆ·ä»£å¸ä½™é¢æ‰£é™¤
```

**EIP-712ç­¾åç»“æ„**:
```javascript
{
  domain: {
    name: "MetaTxForwarder",
    version: "1",
    chainId: 1,
    verifyingContract: "0x..."
  },
  message: {
    from: "0xç”¨æˆ·åœ°å€",
    to: "0xç›®æ ‡åˆçº¦",
    value: 0,
    gas: 500000,
    nonce: 1,
    data: "0xäº¤æ˜“calldata"
  }
}
```

**å…³é”®å‡½æ•°**:
```solidity
- execute(ForwardRequest request, bytes signature) â†’ bool
- executeBatch(ForwardRequest[] requests, bytes[] signatures) â†’ bool
- verify(ForwardRequest request, bytes signature) â†’ bool
- getNonce(address from) â†’ uint256
```

---

#### **4.2 GasStation (Gasè¡¥è´´ç«™)**
ğŸ“ `contracts/metatx/GasStation.sol` | çŠ¶æ€: âœ… å·²å®ç°

**åŠŸèƒ½æè¿°**:
- **Gasè¡¥è´´**: åè®®è¡¥è´´80%çš„gasè´¹ç”¨
- **ä¸­ç»§å™¨æ³¨å†Œ**: ä¸­ç»§å™¨æ³¨å†Œå¹¶å­˜å…¥ä¿è¯é‡‘
- **è´¹ç”¨ç»“ç®—**: æ¯æ¬¡äº¤æ˜“åè‡ªåŠ¨ç»“ç®—
- **èµåŠ©å•†æ¨¡å¼**: é¡¹ç›®æ–¹å¯ä¸ºç‰¹å®šåˆçº¦èµåŠ©gas
- **ä½™é¢è¿½è¸ª**: æ¯ä¸ªä¸­ç»§å™¨çš„gasä½™é¢

**è¡¥è´´æ¨¡å‹**:
```
åœºæ™¯1: åè®®ç»Ÿä¸€è¡¥è´´
- ç”¨æˆ·äº¤æ˜“èŠ±è´¹: 0.001 ETH gas
- åè®®è¡¥è´´80%: 0.0008 ETH
- ä¸­ç»§å™¨å®é™…æˆæœ¬: 0.0002 ETH

åœºæ™¯2: é¡¹ç›®æ–¹å®šå‘è¡¥è´´
- DApp Aä¸ºç”¨æˆ·è¡¥è´´100% gas
- ä»DApp Açš„GasStationä½™é¢æ‰£é™¤
- ä¸­ç»§å™¨å…è´¹æœåŠ¡DApp Aç”¨æˆ·
```

---

#### **4.3 BatchExecutor (æ‰¹é‡æ‰§è¡Œå™¨)**
ğŸ“ `contracts/metatx/BatchExecutor.sol` | çŠ¶æ€: âœ… å·²å®ç°

**åŠŸèƒ½æè¿°**:
- **æ‰¹é‡æ“ä½œ**: ä¸€ç¬”äº¤æ˜“æ‰§è¡Œå¤šä¸ªæ“ä½œ
- **åŸå­æ€§**: å…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å›æ»š
- **çœgas**: æ¯”å¤šç¬”äº¤æ˜“èŠ‚çº¦60%+ gas

**åº”ç”¨åœºæ™¯**:
```solidity
// åœºæ™¯1: ä¸€é”®æ”¶è·å¤šä¸ªç­–ç•¥
batchHarvest([
  aaveStrategyAddress,
  compoundStrategyAddress,
  curveStrategyAddress
])

// åœºæ™¯2: è·¨é‡‘åº“è½¬ç§»
batch([
  vault1.withdraw(token, amount),
  token.approve(vault2, amount),
  vault2.deposit(token, amount)
])

// åœºæ™¯3: æ æ†+æŒ–çŸ¿ç»„åˆ
batch([
  leverageEngine.openPosition(...),
  usdc.approve(vault, amount),
  vault.deposit(usdc, amount)
])
```

---

### 5ï¸âƒ£ è·¨é“¾æ¡¥æ¥ç³»ç»Ÿ

#### **5.1 CrossChainBridge (è·¨é“¾æ¡¥)**
ğŸ“ `contracts/crosschain/CrossChainBridge.sol` | çŠ¶æ€: âœ… å·²å®ç°

**åŠŸèƒ½æè¿°**:
- **æ”¯æŒé“¾**: Ethereum, Arbitrum, Optimism, Polygonç­‰
- **å¤šéªŒè¯å™¨**: éœ€è¦2+éªŒè¯å™¨ç¡®è®¤
- **èµ„äº§æ˜ å°„**: ç»´æŠ¤å„é“¾ä»£å¸å¯¹åº”å…³ç³»
- **è½¬è´¦è¿½è¸ª**: æ¯ç¬”è·¨é“¾è½¬è´¦æœ‰å”¯ä¸€ID
- **çŠ¶æ€æœºåˆ¶**: Pending â†’ Validated â†’ Completed

**è·¨é“¾æµç¨‹**:
```
ç”¨æˆ·åœ¨Ethereumå­˜æ¬¾:
1. ç”¨æˆ·è°ƒç”¨ initiateTransfer(toChain=Arbitrum, token=USDC, amount=1000)
2. åˆçº¦é”å®šç”¨æˆ·1000 USDC
3. å‘å‡º TransferInitiated äº‹ä»¶
4. ç›‘å¬æœåŠ¡æ•è·äº‹ä»¶

éªŒè¯å™¨ç½‘ç»œ:
5. å¤šä¸ªéªŒè¯å™¨ç›‘å¬äº‹ä»¶
6. æ¯ä¸ªéªŒè¯å™¨è°ƒç”¨ confirmTransfer(transferId)
7. è¾¾åˆ°æœ€å°ç¡®è®¤æ•°(å¦‚2ä¸ª)åçŠ¶æ€å˜ä¸ºValidated

Arbitrumé“¾æ¥æ”¶:
8. ä¸­ç»§å™¨åœ¨Arbitrumè°ƒç”¨ completeTransfer(transferId)
9. Arbitrumåˆçº¦é“¸é€ 1000 USDCç»™ç”¨æˆ·
10. çŠ¶æ€å˜ä¸ºCompleted
```

**å®‰å…¨æœºåˆ¶**:
- å¤šç­¾éªŒè¯å™¨(é˜²æ­¢å•ç‚¹ç¯¡æ”¹)
- è½¬è´¦IDå“ˆå¸Œæ ¡éªŒ(é˜²æ­¢åŒèŠ±)
- é“¾ç™½åå•(åªå…è®¸ä¿¡ä»»çš„é“¾)
- ç´§æ€¥æš‚åœåŠŸèƒ½

**å…³é”®å‡½æ•°**:
```solidity
- initiateTransfer(uint256 toChain, address token, uint256 amount) â†’ bytes32 transferId
- confirmTransfer(bytes32 transferId)
- completeTransfer(bytes32 transferId, address recipient, address token, uint256 amount)
- cancelTransfer(bytes32 transferId)
- addValidator(address validator)
- setTokenMapping(address localToken, address remoteToken, uint256 remoteChain)
```

---

#### **5.2 L2Messenger (Layer2æ¶ˆæ¯ä¼ é€’)**
ğŸ“ `contracts/crosschain/L2Messenger.sol` | çŠ¶æ€: âœ… å·²å®ç°

**åŠŸèƒ½æè¿°**:
- **L2ä¸“ç”¨**: é’ˆå¯¹Arbitrum/Optimismç­‰Rollupä¼˜åŒ–
- **æœ¬åœ°æ¡¥æ¥**: ä½¿ç”¨å„L2çš„åŸç”Ÿæ¡¥(æ›´å¿«æ›´ä¾¿å®œ)
- **æ¶ˆæ¯ä¼ é€’**: ä¸ä»…è½¬èµ„äº§,è¿˜èƒ½ä¼ é€’ä»»æ„è°ƒç”¨æ•°æ®

**Arbitrumç¤ºä¾‹**:
```solidity
// L1 â†’ L2 å‘é€æ¶ˆæ¯
sendMessageToL2(
  l2Target: arbitrumVaultAddress,
  data: abi.encodeCall(vault.deposit, (usdc, 1000)),
  maxGas: 500000
)

// ä½¿ç”¨Arbitrum Inboxç³»ç»Ÿ
â†’ æ¶ˆæ¯åœ¨L1æäº¤
â†’ Sequenceråœ¨L2æ‰§è¡Œ
â†’ å‡ åˆ†é’Ÿç¡®è®¤
```

**Optimismç¤ºä¾‹**:
```solidity
// L1 â†’ L2 å‘é€æ¶ˆæ¯
sendMessageToL2(
  l2Target: optimismVaultAddress,
  data: abi.encodeCall(vault.deposit, (usdc, 1000)),
  maxGas: 500000
)

// ä½¿ç”¨Optimism L1CrossDomainMessenger
â†’ æ¶ˆæ¯åœ¨L1æäº¤
â†’ ç«‹å³åœ¨L2æ‰§è¡Œ(å‡å®šæœ‰æ•ˆ)
â†’ 7å¤©æŒ‘æˆ˜æœŸåæœ€ç»ˆç¡®è®¤
```

---

### 6ï¸âƒ£ å®‰å…¨ä¸é£æ§ç³»ç»Ÿ

#### **6.1 AdvancedAccessControl (é«˜çº§æƒé™æ§åˆ¶)**
ğŸ“ `contracts/security/AccessControl.sol` | çŠ¶æ€: âœ… å·²å®ç°

**åŠŸèƒ½æè¿°**:
- **ä¸‰çº§è§’è‰²ä½“ç³»**:
  - **ADMIN**: æœ€é«˜æƒé™,å¯æˆäºˆ/æ’¤é”€ä»»ä½•è§’è‰²
  - **OPERATOR**: è¿è¥æƒé™,å¯è°ƒç”¨æ—¥å¸¸ç®¡ç†å‡½æ•°
  - **KEEPER**: æœºå™¨äººæƒé™,å¯æ‰§è¡Œè‡ªåŠ¨åŒ–ä»»åŠ¡
- **æ—¶é—´é”**: å…³é”®æ“ä½œéœ€ç­‰å¾…2å¤©åç”Ÿæ•ˆ
- **å¤šç­¾è¦æ±‚**: æ•æ„Ÿæ“ä½œéœ€2+ç®¡ç†å‘˜åŒæ—¶ç­¾å
- **æ‰¹é‡æˆæƒ**: ä¸€æ¬¡æ€§æˆäºˆå¤šä¸ªåœ°å€è§’è‰²

**æ—¶é—´é”ç¤ºä¾‹**:
```solidity
åœºæ™¯: æ›´æ¢ç­–ç•¥
1. Adminæäº¤: proposeStrategyChange(newStrategy)
2. è¿›å…¥æ—¶é—´é”: å¿…é¡»ç­‰å¾…2å¤©
3. 2å¤©å: executeStrategyChange(newStrategy)
4. å¦‚æœ‰ç´§æ€¥æƒ…å†µ: cancelStrategyChange()

ç›®çš„: ç»™ç¤¾åŒºæ—¶é—´å®¡æŸ¥,é˜²æ­¢ç®¡ç†å‘˜ä½œæ¶
```

**å¤šç­¾ç¤ºä¾‹**:
```solidity
åœºæ™¯: å‡çº§åˆçº¦
1. Admin1ç­¾å: signUpgrade(newImplementation, signature1)
2. Admin2ç­¾å: signUpgrade(newImplementation, signature2)
3. è¾¾åˆ°2ä¸ªç­¾åé˜ˆå€¼
4. æ‰§è¡Œå‡çº§: executeUpgrade(newImplementation)
```

---

#### **6.2 EmergencyStop (ç´§æ€¥åœæ­¢ç³»ç»Ÿ)**
ğŸ“ `contracts/security/EmergencyStop.sol` | çŠ¶æ€: âœ… å·²å®ç°

**åŠŸèƒ½æè¿°**:
- **å››çº§å“åº”æœºåˆ¶**:
  1. **None (0)**: æ­£å¸¸è¿è¡Œ
  2. **Paused (1)**: æš‚åœå­˜æ¬¾,å…è®¸ææ¬¾
  3. **Frozen (2)**: å†»ç»“æ‰€æœ‰èµ„é‡‘æµåŠ¨
  4. **Shutdown (3)**: å®Œå…¨å…³é—­,ä»…å…è®¸ç´§æ€¥ææ¬¾
- **å‡½æ•°çº§é”å®š**: å¯å•ç‹¬é”å®šç‰¹å®šå‡½æ•°
- **åœ°å€é»‘åå•**: å°ç¦æ¶æ„åœ°å€
- **è‡ªåŠ¨è§£é™¤**: æœ€å¤šæš‚åœ7å¤©åè‡ªåŠ¨è§£é™¤

**ä½¿ç”¨åœºæ™¯**:

**åœºæ™¯1: å‘ç°æ½œåœ¨æ¼æ´**
```
1. Guardianè§¦å‘ setEmergencyLevel(1) - Paused
2. æš‚åœå­˜æ¬¾,é˜²æ­¢æ›´å¤šèµ„é‡‘è¿›å…¥
3. å…è®¸ç”¨æˆ·ææ¬¾
4. å¼€å‘å›¢é˜Ÿä¿®å¤æ¼æ´
5. 7å¤©åè‡ªåŠ¨æ¢å¤æˆ–æ‰‹åŠ¨æ¢å¤
```

**åœºæ™¯2: ä¸¥é‡å®‰å…¨äº‹ä»¶**
```
1. Emergency Roleè§¦å‘ setEmergencyLevel(3) - Shutdown
2. å®Œå…¨å†»ç»“åè®®
3. å¯åŠ¨ç´§æ€¥ææ¬¾é€šé“
4. ç”¨æˆ·é€šè¿‡ emergencyWithdraw() å–å›èµ„é‡‘
```

**å…³é”®å‡½æ•°**:
```solidity
- setEmergencyLevel(EmergencyLevel level)
- lockFunction(bytes4 functionSelector)
- addToBlacklist(address user)
- emergencyWithdraw(address user) â†’ uint256 amount
```

---

#### **6.3 InsuranceFund (ä¿é™©åŸºé‡‘)**
ğŸ“ `contracts/security/InsuranceFund.sol` | çŠ¶æ€: âœ… å·²å®ç°

**åŠŸèƒ½æè¿°**:
- **èµ„é‡‘æ± **: åè®®æ”¶å…¥çš„ä¸€éƒ¨åˆ†æ³¨å…¥ä¿é™©åŸºé‡‘
- **ç†èµ”æµç¨‹**:
  1. ç”¨æˆ·æäº¤ç†èµ”ç”³è¯·
  2. 2+æ‰¹å‡†äººå®¡æ ¸
  3. æ‰¹å‡†åæ”¯ä»˜èµ”å¿
- **èµ”ä»˜ä¸Šé™**: æ¯ç§ä»£å¸æœ‰æœ€å¤§èµ”ä»˜é¢åº¦
- **é€æ˜åº¦**: æ‰€æœ‰ç†èµ”å…¬å¼€å¯æŸ¥

**ç†èµ”æµç¨‹**:
```
1. ç”¨æˆ·é­å—æŸå¤±(å¦‚ç­–ç•¥bugå¯¼è‡´):
   submitClaim(
     token: USDC,
     amount: 10000 USDC,
     evidence: "äº¤æ˜“å“ˆå¸Œ+æŸå¤±æˆªå›¾"
   )

2. Claim ID: 123 ç”Ÿæˆ,çŠ¶æ€: Pending

3. å®¡æ ¸å‘˜1: approveClaim(123)
   å®¡æ ¸å‘˜2: approveClaim(123)
   è¾¾åˆ°2ä¸ªæ‰¹å‡†

4. æ‰§è¡Œæ”¯ä»˜: payClaim(123)
   ç”¨æˆ·æ”¶åˆ° 10000 USDC

5. çŠ¶æ€æ›´æ–°: Paid
```

**èµ„é‡‘æ¥æº**:
```
- åè®®ç»©æ•ˆè´¹çš„20%
- æ¸…ç®—ç½šé‡‘çš„10%
- ç¤¾åŒºæèµ 
- å›½åº“æŠ•èµ„æ”¶ç›Š
```

---

### 7ï¸âƒ£ ä»£å¸ä¸æ”¶ç›Šåˆ†å‰²

#### **7.1 PrincipalToken (æœ¬é‡‘ä»£å¸)**
ğŸ“ `contracts/tokens/PrincipalToken.sol` | çŠ¶æ€: âœ… å·²å®ç°

**åŠŸèƒ½æè¿°**:
- **æœ¬é‡‘ä»£è¡¨æƒ**: åˆ°æœŸåå¯èµå›æœ¬é‡‘
- **å¯äº¤æ˜“**: ERC20æ ‡å‡†,å¯åœ¨DEXäº¤æ˜“
- **åˆ°æœŸèµå›**: åœ¨maturityDateåå¯1:1èµå›æœ¬é‡‘

**åº”ç”¨åœºæ™¯**:
```
ç”¨æˆ·å­˜å…¥1000 USDCåˆ°3ä¸ªæœˆæœŸé‡‘åº“:
â†’ é“¸é€ 1000 PT-USDC-2024Q1(æœ¬é‡‘ä»£å¸)
â†’ é“¸é€ YT-USDC-2024Q1(æ”¶ç›Šä»£å¸)

ç”¨æˆ·å¯ä»¥:
1. æŒæœ‰PTåˆ°æœŸ,èµå›1000 USDCæœ¬é‡‘
2. åœ¨DEXå–å‡ºPT,æå‰è·å¾—æœ¬é‡‘(æŠ˜ä»·)
3. ä¹°å…¥åˆ«äººçš„PT,æŠ˜ä»·è·å¾—æœªæ¥æœ¬é‡‘
```

---

#### **7.2 YieldToken (æ”¶ç›Šä»£å¸)**
ğŸ“ `contracts/tokens/YieldToken.sol` | çŠ¶æ€: âœ… å·²å®ç°

**åŠŸèƒ½æè¿°**:
- **æ”¶ç›Šä»£è¡¨æƒ**: å¯é¢†å–æœŸé—´å†…äº§ç”Ÿçš„æ‰€æœ‰æ”¶ç›Š
- **å®æ—¶ç´¯ç§¯**: æ¯ç§’ç´¯ç§¯æ”¶ç›Š
- **åˆ°æœŸä½œåºŸ**: è¿‡äº†åˆ°æœŸæ—¥ä¸å†äº§ç”Ÿæ”¶ç›Š

**æ”¶ç›Šè®¡ç®—**:
```
ç”¨æˆ·æŒæœ‰100 YT-USDC-2024Q1:
- é‡‘åº“APY: 10%
- æœŸé™: 90å¤©
- é¢„æœŸæ”¶ç›Š: 100 Ã— 10% Ã— (90/365) = 2.47 USDC

æ¯å¤©å¯é¢†å–: 2.47 / 90 = 0.027 USDC
```

**äº¤æ˜“ç­–ç•¥**:
```
çœ‹æ¶¨æ”¶ç›Šç‡:
- ä¹°å…¥YT
- APYä¸Šæ¶¨â†’YTä»·å€¼ä¸Šæ¶¨
- å–å‡ºè·åˆ©

çœ‹è·Œæ”¶ç›Šç‡:
- å–å‡ºYT(å¦‚æœæŒæœ‰)
- APYä¸‹è·Œâ†’YTä»·å€¼ä¸‹è·Œ
```

---

### 8ï¸âƒ£ ä»·æ ¼ä¸é¢„è¨€æœº

#### **8.1 ChainlinkPriceOracle**
ğŸ“ `contracts/mocks/ChainlinkPriceOracle.sol` | çŠ¶æ€: âœ… å·²å®ç°(Mockç‰ˆæœ¬)

**åŠŸèƒ½æè¿°**:
- **ä»·æ ¼æº**: Chainlinkå»ä¸­å¿ƒåŒ–é¢„è¨€æœºç½‘ç»œ
- **å¤šèµ„äº§**: æ”¯æŒETH, BTC, ä¸»æµä»£å¸
- **ä»·æ ¼èšåˆ**: å¤šä¸ªèŠ‚ç‚¹æä¾›ä»·æ ¼,å–ä¸­ä½æ•°
- **æ›´æ–°é¢‘ç‡**: ä»·æ ¼å˜åŠ¨0.5%æˆ–1å°æ—¶æ›´æ–°

**ä»·æ ¼feeds**:
```
ETH/USD: 0x5f4eC3Df9cbd43714FE2740f5E3616155c5b8419
BTC/USD: 0xF4030086522a5bEEa4988F8cA5B36dbC97BeE88c
USDC/USD: 0x8fFfFfd4AfB6115b954Bd326cbe7B4BA576818f6
```

**ä½¿ç”¨ç¤ºä¾‹**:
```solidity
uint256 ethPrice = oracle.getPrice(wethAddress);
// è¿”å›: 2000 * 10^8 (Chainlinkç²¾åº¦8ä½å°æ•°)
// å®é™…ä»·æ ¼: $2000.00
```

---

### 9ï¸âƒ£ è´¹ç”¨ä¸æ”¶å…¥ç®¡ç†

#### **9.1 FeeCollector (è´¹ç”¨æ”¶é›†å™¨)**
ğŸ“ `contracts/mocks/FeeCollector.sol` | çŠ¶æ€: âœ… å·²å®ç°

**åŠŸèƒ½æè¿°**:
- **å¤šç§è´¹ç”¨**:
  - ç»©æ•ˆè´¹: 10%åˆ©æ¶¦
  - ç®¡ç†è´¹: 2% AUMå¹´åŒ–
  - ææ¬¾è´¹: 0.5%
  - æ¸…ç®—ç½šé‡‘: 5%
- **è´¹ç”¨åˆ†é…**:
  - 70% â†’ åè®®è´¢åº“
  - 20% â†’ ä¿é™©åŸºé‡‘
  - 10% â†’ å¼€å‘å›¢é˜Ÿ
- **è‡ªåŠ¨å¤æŠ•**: éƒ¨åˆ†è´¹ç”¨è‡ªåŠ¨ä¹°å…¥æ²»ç†ä»£å¸é”€æ¯

**è´¹ç”¨æµè½¬**:
```
ç”¨æˆ·è·å¾—100 USDCæ”¶ç›Š:
â†’ æ‰£é™¤10 USDCç»©æ•ˆè´¹
â†’ ç”¨æˆ·å®æ”¶90 USDC

10 USDCåˆ†é…:
â†’ 7 USDC â†’ è´¢åº“(ç”¨äºè¿è¥/æ¿€åŠ±)
â†’ 2 USDC â†’ ä¿é™©åŸºé‡‘
â†’ 1 USDC â†’ å¼€å‘å›¢é˜Ÿ
```

---

### ğŸ”Ÿ è‡ªåŠ¨åŒ–æœºå™¨äºº

#### **10.1 HarvestBot (æ”¶è·æœºå™¨äºº)**
ğŸ“ `contracts/mocks/HarvestBot.sol` | çŠ¶æ€: âœ… å·²å®ç°

**åŠŸèƒ½æè¿°**:
- **å®šæ—¶æ”¶è·**: æ¯24å°æ—¶æˆ–æ”¶ç›Šè¾¾é˜ˆå€¼æ—¶è§¦å‘
- **æ‰¹é‡æ‰§è¡Œ**: ä¸€æ¬¡æ”¶è·å¤šä¸ªç­–ç•¥
- **Gasä¼˜åŒ–**: åªåœ¨æ”¶ç›Š>gasæˆæœ¬æ—¶æ‰§è¡Œ
- **æ¿€åŠ±æœºåˆ¶**: Keeperè·å¾—æ”¶ç›Šçš„1%ä½œä¸ºæ¿€åŠ±

**æ‰§è¡Œé€»è¾‘**:
```javascript
function shouldHarvest(strategyAddress) {
  // 1. æ£€æŸ¥ä¸Šæ¬¡æ”¶è·æ—¶é—´
  if (timeSinceLastHarvest < 24 hours) return false;

  // 2. ä¼°ç®—å¾…æ”¶è·æ”¶ç›Š
  uint256 pendingYield = estimateYield(strategyAddress);

  // 3. ä¼°ç®—gasæˆæœ¬
  uint256 gasCost = gasPrice Ã— 200000 gas;

  // 4. æ”¶ç›Š>gasæˆæœ¬çš„2å€æ‰æ‰§è¡Œ
  if (pendingYield > gasCost Ã— 2) {
    harvest(strategyAddress);
    return true;
  }

  return false;
}
```

---

### 1ï¸âƒ£1ï¸âƒ£ ä¸­ç»§å™¨ä¸Gasç®¡ç†

#### **11.1 RelayerRegistry (ä¸­ç»§å™¨æ³¨å†Œè¡¨)**
ğŸ“ `contracts/mocks/RelayerRegistry.sol` | çŠ¶æ€: âœ… å·²å®ç°

**åŠŸèƒ½æè¿°**:
- **ä¸­ç»§å™¨æ³¨å†Œ**: éœ€è¦è´¨æŠ¼1 ETHä¿è¯é‡‘
- **ä¿¡èª‰è¯„åˆ†**: 0-100åˆ†,åˆå§‹50åˆ†
- **è¯„åˆ†æœºåˆ¶**:
  - æˆåŠŸæ‰§è¡Œäº¤æ˜“: +1åˆ†
  - äº¤æ˜“å¤±è´¥: -5åˆ†
  - æ¶æ„è¡Œä¸º: -50åˆ†,è¸¢å‡ºç™½åå•
- **æ”¶ç›Šåˆ†äº«**: é«˜ä¿¡èª‰ä¸­ç»§å™¨è·å¾—æ›´å¤šäº¤æ˜“åˆ†é…

**ä¸­ç»§å™¨æ¿€åŠ±**:
```
åŸºç¡€å¥–åŠ±: å®é™…gasè´¹ Ã— 110%
ä¿¡èª‰åŠ æˆ:
- è¯„åˆ†90+: é¢å¤–10%å¥–åŠ±
- è¯„åˆ†80-89: é¢å¤–5%å¥–åŠ±
- è¯„åˆ†70-79: æ— é¢å¤–å¥–åŠ±
- è¯„åˆ†<70: æ— æ³•æ¥å•
```

---

## ğŸ“Š æ€»ç»“: å·²å®ç°åŠŸèƒ½ç»Ÿè®¡

| æ¨¡å— | åˆçº¦æ•°é‡ | å®Œæˆåº¦ | éƒ¨ç½²çŠ¶æ€ |
|------|---------|--------|---------|
| æ ¸å¿ƒèµ„äº§ç®¡ç† | 3 | 100% | âœ… å·²éƒ¨ç½² |
| æ”¶ç›Šç­–ç•¥ | 4 | 100% | âœ… å¯éƒ¨ç½² |
| æ æ†äº¤æ˜“ | 4 | 100% | ğŸŸ¡ å¾…éƒ¨ç½² |
| å…ƒäº¤æ˜“ç³»ç»Ÿ | 4 | 100% | âœ… å·²éƒ¨ç½² |
| è·¨é“¾æ¡¥æ¥ | 2 | 100% | ğŸŸ¡ å¾…éƒ¨ç½² |
| å®‰å…¨é£æ§ | 3 | 100% | âœ… å·²éƒ¨ç½² |
| ä»£å¸ç³»ç»Ÿ | 2 | 100% | ğŸŸ¡ å¾…éƒ¨ç½² |
| é¢„è¨€æœº | 1 | 100% | âœ… Mockå·²éƒ¨ç½² |
| è´¹ç”¨ç®¡ç† | 1 | 100% | âœ… å·²éƒ¨ç½² |
| è‡ªåŠ¨åŒ– | 3 | 100% | ğŸŸ¡ å¾…éƒ¨ç½² |

**æ€»è®¡**: 27ä¸ªæ ¸å¿ƒåˆçº¦,100%å·²å®ç°,70%å·²éƒ¨ç½²

---

## ğŸ§ª æµ‹è¯•çŠ¶æ€

### âœ… å·²é€šè¿‡æµ‹è¯•:
- Vaultå­˜å–æ¬¾æµç¨‹
- StrategyManagerç­–ç•¥ç®¡ç†
- MetaTxForwarderå…ƒäº¤æ˜“
- LeverageEngineæ æ†å¼€å¹³ä»“
- æƒé™æ§åˆ¶ç³»ç»Ÿ
- ç´§æ€¥åœæ­¢æœºåˆ¶
- ç¼–è¯‘æ— è­¦å‘Š
- ESLintæ£€æŸ¥é€šè¿‡

### ğŸŸ¡ éƒ¨åˆ†é€šè¿‡(åŠŸèƒ½å¾…å®Œå–„):
- YieldAggregatoré›†æˆæµ‹è¯•(13ä¸ªæµ‹è¯•ä¸­10ä¸ªå¾…å®ç°)
- è·¨é“¾æ¡¥æ¥å®Œæ•´æµç¨‹
- è‡ªåŠ¨åŒ–æœºå™¨äººé›†æˆ

### ğŸ“ å¾…å¼€å‘æµ‹è¯•:
- å‹åŠ›æµ‹è¯•(å¤§é¢èµ„é‡‘,é«˜å¹¶å‘)
- æ¨¡ç³Šæµ‹è¯•(Fuzzing)
- ç¬¬ä¸‰æ–¹å®‰å…¨å®¡è®¡
- ä¸»ç½‘åˆ†å‰æµ‹è¯•

---

